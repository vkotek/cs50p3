{% extends "base.html" %}
{% load static %}

{% block title %}
Menu
{% endblock %}

{% block head %}
<script type="text/javascript" src="{% static "js/eshop.js" %}"></script>
{% endblock %}

{% block body %}
<h1>Our Menu</h1>
<hr>
<h3>Regular Pizza</h3>
    <ul>
        {% for item in menu %}
            <li>
                {{item}} <button class="to-cart material-icons" style="display:contents; cursor: pointer; width: 1em;" data-productId="{{item.id}}">add_box</button>
            </li>
        {% endfor %}
    </ul>

<hr>
<h1>Cart</h1>
<ul id="cart">
</ul>

<script>
    document.addEventListener('DOMContentLoaded', (event) => {

        console.log('DOM fully loaded and parsed');
        let addToCartButtons = document.getElementsByClassName('to-cart');
        for ( let button of addToCartButtons ) { 
            button.onclick = function() {

                id = button.dataset['productid']

                addToCart(id);

                
                // v1 - List
                // var cart = localStorage.getItem('cart');
                // cart = cart ? cart.split(',') : [];
                // cart.push(button.dataset['productid'])
                // localStorage.setItem('cart', cart);

                // v2 - JSON object with quantities
                // var id = button.dataset['productid'];
                // var cart = localStorage.getItem('cart');
                // cart = cart ? JSON.parse(cart) : {};
                // [id] = cart[id] ? cart[id]+1 : 1;
                // localStorage.setItem('cart', JSON.stringify(cart));

            };
        }
    });

function reloadCart() {

    const request = new XMLHttpRequest();
    request.open('GET', `/api/v1/cart-text/`);
    request.setRequestHeader('Accept', 'application/json');
    request.setRequestHeader('Content-Type', 'application/json');
    request.onload = () => {
        if ( request.status == 200 ) {
            const response = JSON.parse(request.responseText);
            var ul = document.getElementById("cart");
            ul.innerHTML = "";
            for ( let item of response) {
                var li = document.createElement("li");
                li.appendChild( document.createTextNode(item.item_name));
                li.setAttribute("id", item.id);
                ul.appendChild(li);
            }
        } else {
            M.toast({html: 'Could not refresh cart'});
        }
    }
    request.send();
}

function removeFromCart(itemId) {
    
    const request = new XMLHttpRequest();
    request.open('DELETE', `/api/v1/cart/`);
    request.setRequestHeader('X-CSRFToken', csrftoken);
    request.setRequestHeader('Accept', 'application/json');
    request.setRequestHeader('Content-Type', 'application/json');
    request.onload = () => {
        const response = request.responseText;
        if ( request.status == 200 ) {
            console.log(response);
            M.toast({html: 'Item added to cart!'});
        } else {
            M.toast({html: 'Something went wrong..'});
        }
    }
    let data = JSON.stringify({'id': itemId});
    request.send(data);

    setTimeout(function(){
        reloadCart();
    }, 200);
}

function addToCart(item) {

    const request = new XMLHttpRequest();
    request.open('POST', `/api/v1/cart/`);
    request.setRequestHeader('X-CSRFToken', csrftoken);
    request.setRequestHeader('Accept', 'application/json');
    request.setRequestHeader('Content-Type', 'application/json');
    request.onload = () => {
        const response = request.responseText;
        if ( request.status == 200 ) {
            console.log(response);
            M.toast({html: 'Item added to cart!'});
        } else {
            M.toast({html: 'Something went wrong..'});
        }
    }
    var customer = 1; // TODO: This needs to be somehow fixed...
    let data = JSON.stringify({'customer':customer,'item':item});
    request.send(data);

    setTimeout(function(){
        reloadCart();
    }, 200);
};

// Gets an item from the cookie, e.g. the CSRF token for submitting AJAX requests
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
var csrftoken = getCookie('csrftoken');

</script>

{% endblock %}
